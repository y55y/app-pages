import{R as F,N as k,r as i,j as t,n as S,k as m,S as N,Z as w,q as f,h as Z}from"./index-DoHa3M9S.js";import{p as I,u as J,g as T}from"./fetchdata-4J4RBfRw.js";import{B as Q}from"./index-BTnbaUtT.js";import{A as U}from"./AccountStatement-bE6hfL6D.js";import{A}from"./AutocompleteSearch-Dbd_WzRy.js";import{D as W,a as $,b as P}from"./DialogContent-Bzad8hoa.js";import{D as L}from"./DialogTitle-BhKrG_9L.js";import{T as z}from"./TextField-CBirjhvp.js";import{D as V}from"./DeleteComponent-DadvEn_D.js";import"./Search-BlVTY-uX.js";import"./Autocomplete-IfZomB2Q.js";import"./FormHelperText-BXelP09d.js";import"./InputAdornment-DBH9Y6r2.js";import"./CircularProgress-CNMklcSa.js";import"./DataGrid-BUTxht-w.js";import"./typeof-QjJsDpFa.js";import"./MenuItem-M9AXbarL.js";import"./Checkbox-DQRQH4WJ.js";import"./Skeleton-DkpoRlNA.js";import"./TablePagination-DGZVtQTW.js";import"./KeyboardArrowRight-DSmCqAc2.js";import"./TableCell-C4DEAchp.js";import"./FormControlLabel-CVr2gd5N.js";import"./MessageSnackbar-BinqpbrE.js";import"./SubCard-DDklBriV.js";import"./index-oaPEjgO2.js";import"./TableRow-Dr7dGSgn.js";import"./TableHead-aFXsyTTJ.js";import"./DialogContentText-DxysL3Ro.js";const B=F.memo(({open:e,selectedRowId:a,setMessage:o,setIsLoading:c,onClose:s})=>{const n=k(),[d,y]=i.useState(!1),u=i.useCallback(async()=>{if(!(!e||!a||d)){y(!0),c(!0);try{const p=await I("/api/invoice/new",{Father:a});if(p&&p.InvoiceID)o({open:!0,type:"success",text:"تمت إضافة الفاتورة بنجاح"}),n(`/apps/invoice/edit/${p.InvoiceID}`);else throw new Error("فشل في إضافة الفاتورة")}catch(p){console.error("خطأ في إضافة الفاتورة:",p),p.error.includes("Invalid Father format")?o({open:!0,type:"error",text:"يجب تحديد نوع الفاتورة"}):o({open:!0,type:"error",text:"فشل في إضافة الفاتورة"})}finally{c(!1),s()}}},[e,a,d,o,c,n,s]);return i.useEffect(()=>{e&&!d&&(a?u():(o({open:!0,type:"warning",text:"الرجاء تحديد صف أولاً"}),s()))},[e,a,d,u,o,s]),i.useEffect(()=>{e||y(!1)},[e]),null});B.displayName="AddSub";const O=F.memo(({open:e,selectedSubRowId:a})=>{const o=k(),c=i.useCallback(()=>{e&&a&&(console.log("Redirecting to:",`/apps/invoice/edit/${a}`),o(`/apps/invoice/edit/${a}`))},[e,a,o]);return i.useEffect(()=>{c()},[c]),null});O.displayName="EditSub";const X=({open:e,onClose:a,setMessage:o,selectedRowId:c,mainAccounts:s})=>{const[n,d]=i.useState({Name:"",FatherID:null}),[y,u]=i.useState(null);i.useEffect(()=>{if(c&&s){const r=s.find(h=>h.ID===c);r&&r.Type==="Category"?(u(r),d(h=>({...h,FatherID:r.Code}))):(u(null),d(h=>({...h,FatherID:null})))}},[c,s]);const p=r=>{d({...n,[r.target.name]:r.target.value})},C=r=>{u(r),d({...n,FatherID:r?r.ID:null})},b=async()=>{if(!n.Name.trim()){o({open:!0,type:"error",text:"يرجى إدخال اسم التصنيف"});return}try{const r=await I("/api/items/category",n);r&&r.CategoryID?(o({open:!0,type:"success",text:"تم إنشاء التصنيف بنجاح"}),l()):r&&r.error?o({open:!0,type:"error",text:`حدث خطأ أثناء إنشاء التصنيف: ${r.error}`}):o({open:!0,type:"error",text:"حدث خطأ غير متوقع أثناء إنشاء التصنيف"})}catch(r){console.error("Error creating new category:",r),o({open:!0,type:"error",text:`حدث خطأ أثناء الاتصال بالخادم: ${r.message}`})}},l=()=>{d({Name:"",FatherID:null}),u(null),a()};return t.jsxs(W,{open:e,onClose:l,children:[t.jsx(L,{children:"إضافة تصنيف جديد"}),t.jsxs($,{children:[t.jsx(A,{onOptionSelect:C,placeholder:"ابحث عن تصنيف رئيسي",type:"Category",getOptionLabel:r=>`${r.Name}`,value:y,LoadAllData:!0}),t.jsx(z,{autoFocus:!0,margin:"dense",name:"Name",label:"اسم التصنيف",type:"text",size:"small",fullWidth:!0,variant:"outlined",value:n.Name,onChange:p})]}),t.jsxs(P,{children:[t.jsx(S,{onClick:l,children:"إلغاء"}),t.jsx(S,{onClick:b,children:"حفظ"})]})]})},Y=({open:e,onClose:a,selectedRowId:o,mainAccounts:c,setMessage:s})=>{const[n,d]=i.useState(null),[y,u]=i.useState(null);i.useEffect(()=>{if(o){d(null),u(null);const l=c.find(r=>r.ID===o);if(l)if(l.Type==="Category"){d({...l});const r=c.find(h=>h.ID===l.Father);r&&r.Type==="Category"?u(r):u(null)}else l.Type==="CategoryAuto"?(s({open:!0,type:"error",text:"لا يمكن تعديل تصنيف الي"}),a()):(s({open:!0,type:"error",text:"يمكن تعديل التصنيفات فقط"}),a())}},[e]);const p=l=>{d(r=>({...r,[l.target.name]:l.target.value}))},C=l=>{u(l),d(r=>({...r,FatherID:l?l.ID:null}))},b=async()=>{if(n&&n.Type==="Category")try{const l={Name:n.Name,FatherID:n.FatherID||0};await J("/api/items/category",n.Code,l),s({open:!0,type:"success",text:"تم تحديث التصنيف بنجاح"}),a()}catch(l){console.error("Error updating category:",l),s({open:!0,type:"error",text:"حدث خطأ أثناء تحديث التصنيف"})}else s({open:!0,type:"error",text:"لا يمكن حفظ التغييرات. هذا الحساب ليس تصنيفًا."})};return t.jsxs(W,{open:e,onClose:a,children:[t.jsx(L,{children:"تعديل التصنيف"}),t.jsx($,{children:n&&t.jsxs(t.Fragment,{children:[t.jsx(A,{onOptionSelect:C,placeholder:"ابحث عن تصنيف رئيسي",type:"Category",getOptionLabel:l=>`${l.Name}`,value:y}),t.jsx(z,{autoFocus:!0,margin:"dense",name:"Name",label:"اسم التصنيف",type:"text",size:"small",fullWidth:!0,value:n.Name||"",onChange:p})]})}),t.jsxs(P,{children:[n&&n.Type==="Category"&&t.jsx(V,{resourceId:n.Code,resource:"category",entityName:"التصنيف",onDelete:a,size:"medium",variant:"text"}),t.jsx("div",{style:{flexGrow:1}}),t.jsx(S,{onClick:a,children:"إلغاء"}),t.jsx(S,{onClick:b,disabled:!n,children:"حفظ"})]})]})},M=e=>{switch(e){case 1:return{label:"غير مدفوع",color:"error.main",chipcolor:f("#ffcdd2",.2)};case 2:return{label:"مدفوع جزئي",color:"#fb6300",chipcolor:f("#ffe0b2",.5)};case 3:return{label:"مدفوع",color:"success.dark",chipcolor:f("#c8e6c9",.5)};default:return{label:"غير مدفوع",color:"error.main",chipcolor:f("#ffcdd2",.2)}}},ee=e=>{switch(e){case 1:return{closedlabel:"تحت الاجراء",closedcolor:"black",closedchipcolor:f("#D3D3D3",.3)};case 2:return{closedlabel:"مطلوب التعديل",closedcolor:"info.dark",closedchipcolor:f("#b3e5fc",.5)};case 3:return{closedlabel:"موقف",closedcolor:"error.main",closedchipcolor:f("#ffcdd2",.5)};case 4:return{closedlabel:"تحت التسليم",closedcolor:"black",closedchipcolor:f("#ffecad",.5)};case 5:return{closedlabel:"مستلم",closedcolor:"success.dark",closedchipcolor:f("#c8e6c9",.5)};case 7:return{closedlabel:"مستلم غير مطابق",closedcolor:"black",closedchipcolor:f("#c8e6c9",.5)};case 9:return{closedlabel:"مستلم ناقص",closedcolor:"black",closedchipcolor:f("#c8e6c9",.5)};default:return{closedlabel:"تحت الاجراء",closedcolor:"warning.dark",closedchipcolor:f("#fff9c4",.5)}}},te=e=>e===8?t.jsx(m,{variant:"subtitle1",style:{color:"#673ab7"},children:"مكتملة"}):t.jsx(m,{variant:"subtitle1",style:{color:"grey"},children:"مسودة"}),D=[{field:"ID",headerName:"الرقم",minWidth:100,flex:.5,align:"left",renderCell:e=>t.jsxs(N,{children:[t.jsxs(m,{variant:"h5",align:"center",children:["#",e.row.ReferenceNumber]}),te(e.row.status)]})},{field:"ClientName",headerName:"المورد",minWidth:150,flex:2,align:"left",renderCell:e=>t.jsxs(N,{children:[t.jsx(m,{variant:"h5",children:e.row.ClientName}),t.jsx(m,{variant:"caption",children:e.row.ClientID})]})},{field:"payment_status",headerName:"حالة الدفع",minWidth:150,flex:1,align:"left",renderCell:e=>{const{label:a,color:o,chipcolor:c}=M(e.row.payment_status);return t.jsx(w,{label:a,style:{backgroundColor:c,color:o}})}},{field:"closed",headerName:"حالة الإغلاق",minWidth:150,flex:1,align:"left",renderCell:e=>{const{closedlabel:a,closedcolor:o,closedchipcolor:c}=ee(e.row.closed);return t.jsx(w,{label:a,style:{backgroundColor:c,color:o}})}},{field:"date",headerName:"تاريخ الفاتورة",minWidth:150,flex:1,align:"left",renderCell:e=>t.jsx(m,{variant:"body2",children:e.row.date})},{field:"Total",headerName:"المبلغ الإجمالي",minWidth:150,flex:1,align:"left",renderCell:e=>t.jsx(m,{variant:"body2",children:e.row.Total+e.row.Tax})}],j={columns:D},E={1:{type:"المشتريات",columns:[...D,{field:"purchaseSpecific",headerName:"المشتريات",minWidth:150,flex:1,align:"left",renderCell:e=>t.jsx(m,{variant:"body2",children:e.row.purchaseSpecific})}]},2:{type:"المبيعات",columns:[...D,{field:"salesSpecific",headerName:"المبيعات",minWidth:150,flex:1,align:"left",renderCell:e=>t.jsx(m,{variant:"body2",children:e.row.salesSpecific})}]},3:{type:"التسويات",columns:[...D,{field:"adjustmentSpecific",headerName:"التسويات",minWidth:150,flex:1,align:"left",renderCell:e=>t.jsx(m,{variant:"body2",children:e.row.adjustmentSpecific})}]},4:{type:"الجرد",columns:[...D,{field:"inventorySpecific",headerName:"الجرد",minWidth:150,flex:1,align:"left",renderCell:e=>t.jsx(m,{variant:"body2",children:e.row.inventorySpecific})}]}},re=e=>{if(!e)return j;const a=e.match(/S(\d+)C(\d+)T?(\d+)?/);if(!a)return j;const[,o,c,s]=a;return E[s]||E[c]||j},Ae=()=>{const[e,a]=i.useState([]),[o,c]=i.useState([]),[s,n]=i.useState(0),[d,y]=i.useState(0),[u,p]=i.useState(!1);Z();const[C,b]=i.useState(0),l=[{text:"كشف حساب",component:U,isDisabled:!1}],r=g=>{b(g)},h=async()=>{try{const g=await T("/api/invoices/list/main",{});a(g)}catch(g){console.error("Error fetching client tree data:",g)}},_=async(g,v,q,G,H,K,R)=>{try{p(!0);const x=await T("/api/invoices/list/sub",{Father:g,page:v,pageSize:q,rowID:G,search:H,field:K,sort:R});c(x.data),n(x.totalRows),x.page!==null&&y(x.page),p(!1)}catch(x){console.error("Error fetching client tree data:",x),p(!1)}};return i.useEffect(()=>{h()},[]),t.jsx(Q,{mainData:e,rows:o,dataKey:"ID",dataCode:"Code",Name:"Name",fetchTreeData:h,fetchSubTreeData:_,columns:re(C).columns,apiSearchEndpoint:"/api/accounting/entry/search",PopupAddMain:X,PopupEditMain:Y,AddEntityComponent:B,EditEntityComponent:O,rowCount:s,entityName:"فاتورة",mainName:"موقع",page:d,isLoading:u,setPage:y,reportOptions:l,disableIDTree:!0,isTypeIcon:!0,onSelectedRowIdChange:r})};export{Ae as default};
