import{O as re,K as oe,N as le,r as o,j as e,M as ie,a0 as N,B as F,G as n,I as ce,D as B,S as E,at as j,n as u,z as de,$ as me}from"./index-DOK7aCTJ.js";import{d as D,A as ue}from"./AdapterDayjs-B21T5sN8.js";import{d as pe}from"./PaymentTitle-CBYyLkY3.js";import{a as he,s as xe,e as fe,d as je}from"./payment-hLjTHGah.js";import{T as d,S as L}from"./TextField-DpzXL4Ju.js";import{I as ye}from"./InputAdornment-C1RBlpLr.js";import{A as T}from"./Autocomplete-UszSgsiJ.js";import{L as ge,D as De}from"./DatePicker-DbkhH6gD.js";import{a as W,I as $}from"./FormHelperText-CEQeOJZI.js";import{M as w}from"./MenuItem-B9bun-nE.js";import{C as be}from"./CardActions-afMjIP0M.js";import{C as Ie}from"./CircularProgress-x_j_4Fry.js";import{D as Ce,a as ve,b as Se}from"./DialogContent-Djw2bZG_.js";import{D as ze}from"./DialogTitle-uQU4vRl-.js";import{D as Ae}from"./DialogContentText-AwY6IYYq.js";import"./ListItem-BufBYPe_.js";const He=()=>{const{id:h}=re();oe();const b=le(),[q,I]=o.useState(!1),[C,G]=o.useState(D()),[x,v]=o.useState(""),[K,R]=o.useState([]),[H,_]=o.useState([]),[J,y]=o.useState(!1),[Q,S]=o.useState(""),[z,U]=o.useState([]),[A,V]=o.useState([]),[a,c]=o.useState({sandNo:x,amount:"",reference:"",note:"",clientID:"",paymentMethod:"",safe:"",comment:"",account:"",type:"",date:D(),closed:"",transactions:[]}),[i,k]=o.useState({}),[p,M]=o.useState(!1),[X,Y]=o.useState("");o.useEffect(()=>{let t={};h&&(async()=>{try{t=await he(h),console.log("Fetched payment details:",t),v(t.payment.sandNo),c({...a,...t.payment,sandNo:t.payment.sandNo||x,date:D(t.payment.date)})}catch(r){console.error("Failed to fetch payment details:",r)}})(),console.log("Form data:",t.payment),(async()=>{try{const r=await xe();R(r.safes.filter(f=>parseInt(t.payment.type)===1||parseInt(t.payment.type)===2?!f.isBank:f.isBank)),_(r.paymentMethods),U(r.AccList),V(r.ClientList)}catch(r){console.error("Failed to fetch safes:",r)}})()},[h]);const Z=t=>{if(!t)return"";const l=t.replace(/[^0-9.]/g,"").split("."),r=l[0],f=l[1]?l[1].slice(0,2):"00";return`${r.replace(/\B(?=(\d{3})+(?!\d))/g,",")}.${f}`},m=t=>{const{name:s,value:l}=t.target;s==="amount"?(c({...a,[s]:l}),i.amount&&k({...i,amount:""})):c({...a,[s]:l})},O=t=>{const{name:s,value:l}=t.target;if(s==="amount"){const r=Z(l);c({...a,amount:r})}},ee=()=>{const t={};return a.amount||(t.amount="المبلغ المستلم مطلوب"),a.safe||(t.safe="الصندوق مطلوب"),a.paymentMethod||(t.paymentMethod="طريقة الدفع مطلوبة"),a.account||(t.account="الحساب مطلوب"),t},te=async t=>{t.preventDefault();const s=ee();if(Object.keys(s).length>0)k(s);else{M(!0);try{await fe({...a,sandNo:x,date:C.toISOString()}),b(`/apps/invoice/payment/list/${a.type}`)}catch(l){console.error("Error updating payment:",l),l.message==="SafeACC not found"&&(console.error("SafeACC not found"),S("يجب اضافة رقم حساب للخزينة"),y(!0)),c(r=>({...r,closed:X}))}finally{M(!1)}}},P=()=>{y(!1)},ae=()=>{I(!0)},g=()=>{I(!1)},se=async()=>{try{await je(h),b(`/apps/invoice/payment/list/${a.type}`)}catch(t){console.error("Error deleting payment:",t),S("Failed to delete payment"),y(!0)}g()},ne=()=>{ae()};return e.jsxs(ie,{children:[i.safe&&e.jsx(N,{severity:"error",sx:{mt:2,mb:2},children:i.safe}),e.jsxs("form",{onSubmit:te,children:[e.jsx(F,{sx:{p:2.5},children:e.jsxs(n,{container:!0,spacing:2,children:[e.jsx(n,{item:!0,xs:12,sm:6,md:6,children:e.jsxs(n,{container:!0,spacing:2,children:[e.jsx(n,{item:!0,xs:12,sm:6,md:6,children:e.jsx(d,{fullWidth:!0,label:"المبلغ",id:"amount",name:"amount",size:"small",value:a.amount,onChange:m,onBlur:O,onKeyDown:t=>{t.key==="Enter"&&O(t)},error:!!i.amount,helperText:i.amount,sx:{"& .MuiOutlinedInput-input":{fontSize:"xx-large"}},InputProps:{endAdornment:e.jsx(ye,{position:"end",children:e.jsx(ce,{onClick:()=>c({...a,amount:"123.00"}),children:e.jsx(pe,{})})})}})}),e.jsx(n,{item:!0,xs:8,children:e.jsx(T,{fullWidth:!0,id:"account-autocomplete",options:z,getOptionLabel:t=>`${t.AccID} - ${t.AccName}`,renderInput:t=>e.jsx(d,{...t,label:"الحساب",size:"small",required:!0,error:!!i.account,helperText:i.account}),value:z.find(t=>t.AccID===a.account)||null,onChange:(t,s)=>{c({...a,account:s?s.AccID:""})},noOptionsText:"لا يوجد حسابات مضافة"})}),e.jsx(n,{item:!0,xs:4,children:e.jsx(T,{id:"autocomplete-client",options:A,getOptionLabel:t=>t?t.ClientName:"",renderInput:t=>e.jsx(d,{...t,label:parseInt(a.type)===2||parseInt(a.type)===3?"المورد":"العميل",size:"small"}),value:A.find(t=>t.ClientID===a.clientID)||null,onChange:(t,s)=>{c({...a,clientID:s?s.ClientID:"",account:s&&s.accNo?s.accNo:""})},isOptionEqualToValue:(t,s)=>t.ClientID===s.ClientID,noOptionsText:"لا يوجد عملاء مضافين"})}),e.jsx(n,{item:!0,xs:8,children:e.jsx(d,{fullWidth:!0,label:parseInt(a.type)===2||parseInt(a.type)===3?"المستلم":"وذلك مقابل",id:"comment",name:"comment",size:"small",value:a.comment,onChange:m})}),e.jsx(n,{item:!0,xs:4,children:e.jsx(d,{fullWidth:!0,label:"المرجع",id:"reference",name:"reference",size:"small",value:a.reference,onChange:m})})]})}),e.jsx(n,{item:!0,xs:12,sm:6,md:3}),e.jsx(n,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(n,{container:!0,spacing:2,children:[e.jsx(n,{item:!0,xs:12,children:e.jsx(d,{fullWidth:!0,label:"رقم السند",id:"receiptID",name:"receiptID",size:"small",value:x,required:!0,disabled:!0,onChange:t=>v(t.target.value)})}),e.jsx(n,{item:!0,xs:12,children:e.jsx(ge,{dateAdapter:ue,children:e.jsx(De,{slotProps:{textField:{fullWidth:!0,size:"small"}},label:"التاريخ",value:C,onChange:t=>G(t)})})}),e.jsx(n,{item:!0,xs:12,children:e.jsxs(W,{fullWidth:!0,children:[e.jsx($,{id:"box-select-label",size:"small",children:parseInt(a.type)===1||parseInt(a.type)===2?"الصندوق":"البنك"}),e.jsx(L,{labelId:"box-select-label",label:parseInt(a.type)===1||parseInt(a.type)===2?"الصندوق":"البنك",size:"small",name:"safe",value:a.safe,onChange:m,error:!!i.safe,children:K.map(t=>e.jsx(w,{value:t.safeID,children:t.safeName},t.safeID))})]})}),e.jsx(n,{item:!0,xs:12,children:e.jsxs(W,{fullWidth:!0,children:[e.jsx($,{id:"payment-method-label",size:"small",children:"طريقة الدفع"}),e.jsx(L,{labelId:"payment-method-label",label:"طريقة الدفع",size:"small",name:"paymentMethod",value:a.paymentMethod,onChange:m,error:!!i.paymentMethod,children:H.map(t=>e.jsx(w,{value:t.paymentMethodID,children:t.paymentMethodName},t.paymentMethodID))})]})})]})})]})}),e.jsx(B,{}),e.jsx(F,{sx:{p:2.5},children:e.jsx(d,{fullWidth:!0,multiline:!0,rows:2,label:"ملاحظات",id:"note",name:"note",value:a.note,onChange:m})}),e.jsx(B,{}),e.jsxs(be,{sx:{justifyContent:"space-between"},children:[e.jsxs(E,{direction:"row",spacing:1.5,children:[e.jsx(j,{children:e.jsx(u,{type:"submit",variant:"outlined",size:"large",color:"secondary",onClick:()=>{Y(a.closed),c({...a,closed:!a.closed})},disabled:p,children:a.closed?"الغاء الترحيل":"ترحيل"})}),!a.closed&&e.jsx(j,{children:e.jsx(u,{variant:"outlined",color:"error",size:"large",onClick:ne,disabled:p,children:"حذف"})})]}),e.jsxs(E,{direction:"row",spacing:1.5,children:[e.jsx(j,{children:e.jsx(u,{variant:"contained",size:"large",type:"submit",disabled:p,children:p?e.jsx(Ie,{size:24}):"حفظ"})}),e.jsx(j,{children:e.jsx(u,{variant:"outlined",component:de,to:`/apps/invoice/payment/list/${a.type}`,size:"large",disabled:p,children:"الغاء"})})]})]})]}),e.jsx(me,{open:J,autoHideDuration:6e3,onClose:P,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(N,{onClose:P,severity:"error",sx:{width:"100%"},children:Q})}),e.jsxs(Ce,{open:q,onClose:g,"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description",children:[e.jsx(ze,{id:"alert-dialog-title",children:"تأكيد الحذف"}),e.jsx(ve,{children:e.jsx(Ae,{id:"alert-dialog-description",children:"هل أنت متأكد أنك تريد حذف السند؟"})}),e.jsxs(Se,{children:[e.jsx(u,{onClick:g,children:"إلغاء"}),e.jsx(u,{onClick:se,autoFocus:!0,children:"حذف"})]})]})]})};export{He as default};
