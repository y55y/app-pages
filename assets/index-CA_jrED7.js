import{R as te,j as e,P as x,B as E,G as a,m as P,E as re,r as h,F as se,H as ne,J as oe,K as ie,N as ae,O as le,Q as ce,M as ue,n as w,U as K}from"./index-CK2eHZDS.js";import{g as T,s as k,a as me,f as de,u as U,C as R,b as pe,F as fe}from"./index-CpRJSQr9.js";import{c as he,a as G}from"./formik.esm-BfSmdhbL.js";import{g as xe,c as ge}from"./invoice-BCKW537N.js";import{T as C}from"./TextField--NRucxkR.js";import Ie from"./index-BjxkR9ty.js";import{g as ve}from"./userinfo-Dj6RO7mX.js";import Se from"./index-CRA2x4nE.js";import{A as $}from"./Autocomplete-DwoJzscJ.js";import{D as H}from"./DialogContent-B6RC-5yg.js";import"./typeof-QjJsDpFa.js";import"./FormHelperText-DhsFkHK6.js";import"./InputFileUpload-CZCawxZ7.js";import"./CardMedia-B8d1hyj_.js";import"./Delete-nHBTa-3K.js";import"./client-BiKSUi9J.js";import"./DialogTitle-Do-b2gQd.js";import"./Tabs-DcU0Kiic.js";import"./KeyboardArrowRight-CmUX_fuU.js";import"./DeleteComponent-B9Nv_Ya4.js";import"./fetchdata-7caSym0v.js";import"./MessageSnackbar-CYglifX9.js";import"./DialogContentText-BTgKtHs8.js";import"./CircularProgress-CbH74Q3r.js";var J=function(n,r,i){if(n&&"reportValidity"in n){var l=T(i,r);n.setCustomValidity(l&&l.message||""),n.reportValidity()}},Q=function(n,r){var i=function(I){var o=r.fields[I];o&&o.ref&&"reportValidity"in o.ref?J(o.ref,I,n):o.refs&&o.refs.forEach(function(s){return J(s,I,n)})};for(var l in r.fields)i(l)},je=function(n,r){r.shouldUseNativeValidation&&Q(n,r);var i={};for(var l in n){var I=T(r.fields,l),o=Object.assign(n[l]||{},{ref:I&&I.ref});if(be(r.names||Object.keys(n),l)){var s=Object.assign({},T(i,l));k(s,"root",o),k(i,l,s)}else k(i,l,o)}return i},be=function(n,r){return n.some(function(i){return i.startsWith(r+".")})};function Ce(n,r,i){return r===void 0&&(r={}),i===void 0&&(i={}),function(l,I,o){try{return Promise.resolve(function(s,g){try{var u=(r.context,Promise.resolve(n[i.mode==="sync"?"validateSync":"validate"](l,Object.assign({abortEarly:!1},r,{context:I}))).then(function(m){return o.shouldUseNativeValidation&&Q({},o),{values:i.raw?l:m,errors:{}}}))}catch(m){return g(m)}return u&&u.then?u.then(void 0,g):u}(0,function(s){if(!s.inner)throw s;return{values:{},errors:je((g=s,u=!o.shouldUseNativeValidation&&o.criteriaMode==="all",(g.inner||[]).reduce(function(m,d){if(m[d.path]||(m[d.path]={message:d.message,type:d.type}),u){var y=m[d.path].types,S=y&&y[d.type];m[d.path]=me(d.path,u,m,d.type,S?[].concat(S,d.message):d.message)}return m},{})),o)};var g,u}))}catch(s){return Promise.reject(s)}}}te.forwardRef((n,r)=>{const i={},l={};return e.jsx(C,{ref:r,sx:n.select?i:l,...n,size:"small"})});const X=({client:n,invoiceData:r,handleOnSelectValue:i})=>{const I=de(new Date,"yyyy/MM/dd"),o=g=>{const u=g.target.value;i({...r,invoice_id:u})},s=(g,u,m=!0,d=!0)=>e.jsx(C,{fullWidth:m,value:u||"",label:g,variant:"outlined",sx:{"& .MuiInputBase-inputSizeSmall":{fontSize:"medium"},"& .MuiInputLabel-root":{fontSize:"1rem",color:u?"black":"#2196f3"},"& .MuiOutlinedInput-input.Mui-disabled":{WebkitTextFillColor:"#2196f3"}},disabled:d,size:"small"});return e.jsx(E,{children:e.jsx(a,{container:!0,spacing:P,children:e.jsx(a,{item:!0,xs:12,children:e.jsxs(E,{sx:{border:"1px solid #ccc",p:2,borderRadius:1,mb:2},children:[e.jsx(E,{sx:{fontWeight:"bold",mb:1,backgroundColor:"#ede7f66b",p:1,borderRadius:"4px"},children:"المعلومات"}),e.jsxs(a,{container:!0,spacing:2,children:[e.jsx(a,{item:!0,xs:3,children:e.jsx(C,{value:r.invoice_id||"",label:"رقم المرجع",variant:"outlined",sx:{"& .MuiInputBase-inputSizeSmall":{fontSize:"medium"},"& .MuiInputLabel-root":{fontSize:"1rem",color:r.invoice_id?"black":"#2196f3"},"& .MuiOutlinedInput-input.Mui-disabled":{WebkitTextFillColor:"#2196f3"}},size:"small",onChange:o})}),e.jsx(a,{item:!0,xs:3,children:s("تاريخ الفاتورة",I)}),e.jsx(a,{item:!0,xs:3,children:s("حالة الفاتورة",r.status)}),e.jsx(a,{item:!0,xs:3,children:s("حالة الدفع",r.paymentStatus)}),e.jsx(a,{item:!0,xs:8,children:s("العنوان",n.location)}),e.jsx(a,{item:!0,xs:4,children:s("الرقم الضريبي",n.vat)})]})]})})})})};X.propTypes={client:x.shape({id:x.string,name:x.string,email:x.string,phone:x.string,location:x.string,category:x.string,vat:x.string}),invoiceData:x.shape({invoice_id:x.string,date:x.oneOfType([x.string,x.instanceOf(Date)]),status:x.string,paymentStatus:x.string}),handleOnSelectValue:x.func.isRequired};const Y=({handleOnSelectValue:n,invoiceData:r,handleInvoiceIdEdit:i,saveButtonRef:l})=>{const I=re(),{control:o,setValue:s,formState:{errors:g}}=U(),[u,m]=h.useState([]),[d,y]=h.useState([]),[S,j]=h.useState(!1),{detailCards:D}=se(t=>t.user),[z,N]=h.useState(null),[p,f]=h.useState(""),[b,A]=h.useState(!1);U(),h.useEffect(()=>{M(),_()},[I]);const B=h.useRef(null),F=h.useRef(null),V=h.useRef(null);h.useEffect(()=>{B.current.focus()},[]);const O=(t,c)=>{t.key==="Enter"&&(t.preventDefault(),c.current.focus())};h.useEffect(()=>{M(),_()},[I]);const M=async()=>{I(ne())},_=async()=>{try{const t=await ve();t&&Array.isArray(t.stores)?y(t.stores):console.error("Fetched data does not contain stores array:",t)}catch(t){console.error("Error fetching locations:",t.message)}};h.useEffect(()=>{if(D.length>0&&(m(D),r&&r.ClientID)){const t=D.find(c=>c.ClientID===r.ClientID);N(t),t&&(s("ClientID",t.ClientID),s("customerName",t.name),s("customerEmail",t.email),s("customerPhone",t.phone),s("customerAddress",t.address))}r&&r.store&&f(r.store)},[D]);const W=()=>{j(t=>!t)},Z=()=>{A(t=>!t)},ee=t=>{m(c=>[...c,t.newClient]),N(t.newClient),s("ClientID",t.ClientID),s("customerName",t.name),s("customerEmail",t.email),s("customerPhone",t.phone),s("customerAddress",t.address)},q=()=>{A(!1),M()};return e.jsxs(a,{container:!0,spacing:2,children:[e.jsx(a,{item:!0,xs:12,md:3,children:e.jsx(E,{sx:{border:"0px solid #ccc",p:0,borderRadius:1,mb:2},children:e.jsxs(a,{container:!0,spacing:2,children:[e.jsx(a,{item:!0,xs:12,children:e.jsx(R,{name:"ClientID",control:o,render:({field:t})=>e.jsx($,{...t,options:u,getOptionLabel:c=>c?c.name:"",value:u.find(c=>c.ClientID===t.value)||null,onChange:(c,v)=>{n(v),t.onChange(v?v.ClientID:"")},renderInput:c=>{var v;return e.jsx(C,{...c,label:"المورد",placeholder:"حدد المورد",size:"small",sx:{"& .MuiInputBase-inputSizeSmall":{fontSize:"medium"},"& .MuiInputLabel-root":{fontSize:"1rem",color:"black"}},error:!!g.ClientID,helperText:(v=g.ClientID)==null?void 0:v.message,inputRef:B,onKeyDown:L=>O(L,F)})}})})}),e.jsx(a,{item:!0,xs:12,children:e.jsx(R,{name:"SupplierInvoiceNumber",control:o,render:({field:t})=>e.jsx(C,{...t,size:"small",id:"SupplierInvoiceNumber",name:"SupplierInvoiceNumber",label:"رقم فاتورة المورد",placeholder:"ادخل رقم فاتورة المورد",sx:{"& .MuiInputBase-inputSizeSmall":{fontSize:"medium"},"& .MuiInputLabel-root":{fontSize:"1rem",color:"black"}},InputLabelProps:{style:{fontSize:"1rem",color:"black"}},inputRef:F,onKeyDown:c=>O(c,V),requaired:!0})})}),e.jsx(a,{item:!0,xs:12,children:e.jsx(R,{name:"store",control:o,render:({field:t})=>e.jsx($,{...t,id:"store-autocomplete",options:d,getOptionLabel:c=>c.StoreName||"",size:"small",value:d.find(c=>c.StoreID===t.value)||null,onChange:(c,v)=>{t.onChange(v?v.StoreID:""),f(v?v.StoreID:"")},requaired:!0,renderInput:c=>{var v;return e.jsx(C,{...c,label:e.jsx(oe,{id:"Location"}),placeholder:"اختر الفرع",size:"small",sx:{"& .MuiInputBase-inputSizeSmall":{fontSize:"medium"},"& .MuiInputLabel-root":{fontSize:"1rem",color:"black"}},inputRef:V,onKeyDown:L=>O(L,l),error:!!g.store,helperText:(v=g.store)==null?void 0:v.message})}})})})]})})}),e.jsx(a,{item:!0,xs:12,md:3,children:e.jsx(E,{sx:{border:"0px solid #ccc",p:0,borderRadius:1,mb:2},children:e.jsx(a,{item:!0,xs:12,children:e.jsx(R,{name:"Comment",control:o,render:({field:t})=>e.jsx(C,{...t,fullWidth:!0,id:"Comment",name:"Comment",label:"ملاحظات",multiline:!0,rows:6,size:"small",placeholder:"اضف ملاحظة",sx:{"& .MuiInputBase-inputSizeSmall":{fontSize:"medium"},"& .MuiInputLabel-root":{fontSize:"1rem",color:"black"}}})})})})}),e.jsx(a,{item:!0,xs:12,md:6,children:e.jsx(X,{client:z||{},invoiceData:r,handleOnSelectValue:i})}),e.jsx(H,{open:S,onClose:W,sx:{"& .MuiDialog-paper":{maxWidth:"100%",width:980}},children:S&&e.jsx(Ie,{onClientCreated:ee,handleDialogToggler:W})}),e.jsx(H,{open:b,onClose:q,sx:{"& .MuiDialog-paper":{maxWidth:"100%",width:980}},children:b&&e.jsx(Se,{clientId:z==null?void 0:z.ClientID,handleDialogToggler:Z,handleClose:q,fetchClientsData:M})})]})};Y.propTypes={handleOnSelectValue:x.func.isRequired,invoiceData:x.object};const ye=he({ClientID:G().required("المورد اجباري"),store:G().required("الفرع اجباري")}),Je=()=>{const n=ie(),r=ae(),i=h.useRef(null),{status:l}=le(),[I,o]=h.useState(!1),[s,g]=h.useState(null),[u,m]=h.useState({}),d=pe({defaultValues:{invoice_id:"",customerName:"",customerEmail:"",customerPhone:"",customerAddress:"",ClientID:"",invDate:new Date,SupplierInvoiceNumber:"",store:"",Comment:"",status:l},resolver:Ce(ye)}),{handleSubmit:y,setValue:S,watch:j}=d;h.useEffect(()=>{(async()=>{try{const f=await xe();g(f),m(b=>({...b,invoice_id:f}))}catch(f){console.error("Error fetching the next invoice ID:",f)}})()},[]);const D=h.useCallback(p=>{S("customerName",p.name),S("customerEmail",p.email),S("customerPhone",p.phone),S("customerAddress",p.address),S("ClientID",p.ClientID),m(f=>({...f,customerName:p.name,customerEmail:p.email,customerPhone:p.phone,customerAddress:p.address,ClientID:p.ClientID}))},[S]),z=p=>{m(f=>({...f,invoice_id:p.invoice_id,ClientID:p.ClientID||f.ClientID,store:p.store||f.store,SupplierInvoiceNumber:p.SupplierInvoiceNumber||f.SupplierInvoiceNumber,Comment:p.Comment||f.Comment}))},N=async p=>{o(!0);try{const f={...u,invoice_id:u.invoice_id||s,customerName:j("customerName"),customerEmail:j("customerEmail"),customerPhone:j("customerPhone"),customerAddress:j("customerAddress"),ClientID:u.ClientID,store:j("store"),SupplierInvoiceNumber:j("SupplierInvoiceNumber"),Comment:j("Comment"),date:new Date().toISOString(),status:l},b=await ge(f);b&&(n(K({open:!0,message:"تم إنشاء الفاتورة بنجاح!",variant:"alert",alert:{color:"success"},close:!1})),r(`/apps/invoice/edit/${b.OrderID}`))}catch(f){console.error("حدث خطأ أثناء إنشاء الفاتورة:",f),n(K({open:!0,message:"حدث خطأ أثناء إنشاء الفاتورة",variant:"alert",alert:{color:"error"},close:!1}))}finally{o(!1)}};return e.jsx(ce,{children:e.jsx(ue,{children:e.jsx(fe,{...d,children:e.jsx("form",{onSubmit:y(N),children:e.jsxs(a,{container:!0,spacing:P,children:[e.jsx(a,{item:!0,xs:12,children:e.jsx(e.Fragment,{children:e.jsx(Y,{handleOnSelectValue:D,invoiceData:u,handleInvoiceIdEdit:z,saveButtonRef:i})})}),e.jsx(a,{item:!0,xs:12,children:e.jsxs(a,{container:!0,spacing:P,children:[e.jsx(a,{item:!0,children:e.jsx(w,{color:"secondary",variant:"outlined",onClick:()=>r(-1),children:"الغاء"})}),e.jsx(a,{item:!0,children:e.jsx(w,{color:"primary",variant:"contained",type:"submit",disabled:!s,ref:i,children:"خفظ"})})]})})]})})})})})};export{Je as default};
