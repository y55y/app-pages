import{r as u,R as $,j as e,ax as J,B as C,k as q,ak as U,n as E,aO as V,aP as X,aQ as Y}from"./index-aLGb3jn2.js";import{g as L}from"./fetchdata-BVhae-Sj.js";import{B as Z}from"./index-Dre5FEt3.js";import{A as _}from"./AccountStatement-CvQ1wsf1.js";import{S as ee}from"./SubCard-CGXIfH6Y.js";import{R as te}from"./index-i8J2AbaV.js";import{T as re,a as ne,b as v,c as ce}from"./TableRow-BI0usBty.js";import{T as ae}from"./TableHead-Bq_dg3Ch.js";import{T as D}from"./TableCell-Xf62W0pa.js";import{D as F,a as W,b as k}from"./DialogContent-DOLakJo1.js";import{D as B}from"./DialogTitle-BOxhjpgh.js";import{T as N}from"./TextField-DmYAvsu5.js";import{A as M}from"./Autocomplete-DQY59Bm2.js";import{R as G,a as w}from"./RadioGroup-CN2xqUiT.js";import{F as I}from"./FormControlLabel-B_DYhieH.js";import{C as z}from"./CircularProgress-BMwP3mXy.js";import{D as oe}from"./DialogContentText-i0ZblITF.js";import"./Search-BPLgMnKj.js";import"./InputAdornment-ZDCZgk70.js";import"./FormHelperText-DSN7KoA_.js";import"./TablePagination-DMgjs3Vx.js";import"./KeyboardArrowRight-BlHJQliR.js";import"./MenuItem-E4UeQKVO.js";import"./DataGrid-BRFOsmUh.js";import"./typeof-QjJsDpFa.js";import"./Checkbox-CwtUmqz0.js";import"./Skeleton-BvzZx4MC.js";import"./MessageSnackbar-Del1lRT9.js";const se=({open:p,onClose:g,rows:b,setMessage:S,mainAccounts:j})=>{const[o,a]=u.useState(null),r=u.useRef(!1),m=u.useRef(),d=u.useCallback(()=>{r.current||!p||(a({period:"2024",issueDate:"01-10-2024",accounts:j}),r.current=!0)},[p]);u.useEffect(()=>{d()},[p]),u.useEffect(()=>{if(o&&o.accounts&&o.accounts.length>0){const A=document.querySelector('button[style="display: none;"]');A&&A.click(),g()}},[o]);const T=$.forwardRef((A,y)=>{if(!o||!o.accounts||o.accounts.length===0)return null;const f=o.accounts.reduce((l,s)=>l+(s.Debit||0),0),i=o.accounts.reduce((l,s)=>l+(s.Credit||0),0),h=(l=>{const s=new Map,t=[];return l.forEach(c=>{c.children=[],s.set(c.AccID,c)}),l.forEach(c=>{c.Father&&s.has(c.Father)?s.get(c.Father).children.push(c):t.push(c)}),t})(o.accounts),x=(l,s=0)=>l.map((t,c)=>e.jsxs($.Fragment,{children:[e.jsxs(v,{sx:{backgroundColor:c%2===0?"#f9f9f9":"#fff"},children:[e.jsx(D,{align:"left",sx:{paddingLeft:`${s*20}px`},children:t.AccID}),e.jsx(D,{align:"left",children:t.AccName}),e.jsx(D,{align:"right",children:t.Debit?t.Debit.toFixed(2):0}),e.jsx(D,{align:"right",children:t.Credit?t.Credit.toFixed(2):0})]}),t.children&&x(t.children,s+1)]},t.AccID));return e.jsxs(ee,{ref:y,title:"ميزان المراجعة",secondary:e.jsx(J,{}),sx:{direction:"ltr",display:"none","@media print":{display:"block"},maxWidth:900,margin:"auto"},children:[e.jsxs(C,{display:"flex",justifyContent:"space-between",mb:3,children:[e.jsxs(q,{variant:"body1",children:[e.jsx("strong",{children:"الفترة:"})," ",o.period]}),e.jsxs(q,{variant:"body1",children:[e.jsx("strong",{children:"تاريخ الإصدار:"})," ",o.issueDate]})]}),e.jsx(re,{component:U,sx:{border:"1px solid #ddd",boxShadow:"none"},children:e.jsxs(ne,{size:"small",children:[e.jsx(ae,{children:e.jsxs(v,{sx:{backgroundColor:"#d3d3d3"},children:[e.jsx(D,{children:e.jsx("strong",{children:"رقم الحساب"})}),e.jsx(D,{children:e.jsx("strong",{children:"اسم الحساب"})}),e.jsx(D,{align:"right",children:e.jsx("strong",{children:"مدين"})}),e.jsx(D,{align:"right",children:e.jsx("strong",{children:"دائن"})})]})}),e.jsxs(ce,{children:[x(h),e.jsxs(v,{sx:{backgroundColor:"#f0f0f0",fontWeight:"bold"},children:[e.jsx(D,{colSpan:2,children:"الإجمالي"}),e.jsx(D,{align:"right",children:f?f.toFixed(2):0}),e.jsx(D,{align:"right",children:i?i.toFixed(2):0})]})]})]})})]})});return e.jsxs("div",{children:[e.jsx(te,{trigger:()=>e.jsx("button",{style:{display:"none"}}),content:()=>m.current}),o&&e.jsx(T,{ref:m})]})},H=({open:p,onClose:g,addType:b=2,rows:S,selectedRowId:j,mainAccounts:o})=>{const[a,r]=u.useState({accountName:"",notes:"",accountNumber:"",mainAccount:null,accountType:1,permission:null,AccRef:""}),[m,d]=u.useState({}),[T,A]=u.useState(!1);u.useEffect(()=>{const n=o.find(h=>h.AccID===j);n&&f("mainAccount")(null,n)},[j,o]);const y=n=>{if(!n){r(s=>({...s,accountNumber:"",accountType:1}));return}const h=n.AccD?1:0,x=b===1?o.filter(s=>s.Father===n.AccID):S.filter(s=>s.Father===n.AccID);let l;x.length>0?l=(Math.max(...x.map(t=>parseInt(t.AccID)))+1).toString():l=n.AccID+(b===1?"01":"001"),r(s=>({...s,accountNumber:l,accountType:h}))},f=n=>(h,x)=>{n==="mainAccount"?(r({...a,mainAccount:x}),y(x)):r(n==="permission"?{...a,[n]:x}:n==="accountType"?{...a,accountType:parseInt(h.target.value)}:{...a,[n]:h.target.value}),d({...m,[n]:""})},i=async()=>{const n={};if(a.accountName.trim()||(n.accountName="اسم الحساب مطلوب"),a.accountNumber.trim()||(n.accountNumber="رقم الحساب مطلوب"),a.mainAccount||(n.mainAccount="الحساب الرئيسي مطلوب"),Object.keys(n).length>0){d(n);return}A(!0);try{const h={accountNumber:a.accountNumber,accountType:b,AccName:a.accountName,Father:a.mainAccount?a.mainAccount.AccID:null,AccD:a.accountType,AccNote:a.notes,AccRef:a.AccRef};await V(h),g()}catch(h){console.error("Error submitting form:",h)}finally{A(!1)}};return e.jsxs(F,{open:p,onClose:g,maxWidth:"sm",fullWidth:!0,children:[e.jsx(B,{children:b===1?"اضافة حساب رئيسي":"اضافة حساب"}),e.jsx(W,{children:e.jsxs(C,{sx:{display:"flex",justifyContent:"space-between",gap:2},children:[e.jsxs(C,{sx:{flex:1},children:[e.jsx(N,{label:"اسم الحساب",value:a.accountName,onChange:f("accountName"),fullWidth:!0,required:!0,margin:"normal",error:!!m.accountName,helperText:m.accountName}),e.jsx(N,{label:"رقم المرجع",value:a.AccRef,onChange:f("AccRef"),type:"number",fullWidth:!0,margin:"normal",error:!!m.AccRef,helperText:m.AccRef}),e.jsx(N,{label:"ملاحظات",value:a.notes,onChange:f("notes"),fullWidth:!0,margin:"normal",multiline:!0,rows:4})]}),e.jsxs(C,{sx:{flex:1},children:[e.jsx(N,{label:"رقم الحساب",value:a.accountNumber,onChange:f("accountNumber"),type:"number",fullWidth:!0,required:!0,margin:"normal",error:!!m.accountNumber,helperText:m.accountNumber}),e.jsx(M,{options:o,getOptionLabel:n=>`${n.AccID} - ${n.AccName}`,value:o.find(n=>n.AccID===j)||a.mainAccount||null,onChange:f("mainAccount"),renderInput:n=>e.jsx(N,{...n,label:"الحساب الرئيسي",margin:"normal",required:!0,error:!!m.mainAccount,helperText:m.mainAccount}),fullWidth:!0}),e.jsxs(G,{value:a.accountType.toString(),onChange:f("accountType"),row:!0,sx:{mt:2},children:[e.jsx(I,{value:"1",control:e.jsx(w,{}),label:"دائن"}),e.jsx(I,{value:"0",control:e.jsx(w,{}),label:"مدين"})]})]})]})}),e.jsxs(k,{children:[e.jsx(E,{onClick:g,color:"secondary",children:"إلغاء"}),e.jsx(E,{onClick:i,color:"primary",variant:"contained",disabled:T,children:T?e.jsxs(e.Fragment,{children:["قيد الاضافة",e.jsx(z,{size:24,sx:{ml:1}})]}):"إضافة حساب"})]})]})},ie=p=>e.jsx(H,{...p,addType:1}),K=({open:p,onClose:g,editType:b=2,rows:S,selectedRowId:j,selectedSubRowId:o,mainAccounts:a})=>{const[r,m]=u.useState({accountName:"",notes:"",accountNumber:"",mainAccount:null,accountType:1,permission:null,AccRef:""}),[d,T]=u.useState({}),[A,y]=u.useState(!1),[f,i]=u.useState(!1);u.useEffect(()=>{if(j){console.log(S);const t=b===1?a.find(c=>c.AccID===j):S.find(c=>c.AccID===o);t&&m({accountName:t.AccName,notes:t.AccNote||"",accountNumber:t.AccID,mainAccount:a.find(c=>c.AccID===t.Father)||null,accountType:t.AccD?1:0,AccRef:t.AccRef||""})}},[j,a]);const n=()=>{i(!0)},h=async()=>{y(!0);try{const t={accountNumber:r.accountNumber,accountType:b};await X(t),g()}catch(t){console.error("Error deleting account:",t)}finally{y(!1),i(!1)}},x=()=>{i(!1)},l=t=>(c,R)=>{m(t==="mainAccount"?{...r,mainAccount:R}:t==="permission"?{...r,[t]:R}:t==="accountType"?{...r,accountType:parseInt(c.target.value)}:{...r,[t]:c.target.value}),T({...d,[t]:""})},s=async()=>{const t={};if(r.accountName.trim()||(t.accountName="اسم الحساب مطلوب"),String(r.accountNumber).trim()||(t.accountNumber="رقم الحساب مطلوب"),r.mainAccount||(t.mainAccount="الحساب الرئيسي مطلوب"),Object.keys(t).length>0){T(t);return}y(!0);try{const c={accountNumber:r.accountNumber,accountType:b,AccName:r.accountName,Father:r.mainAccount?r.mainAccount.AccID:null,AccD:r.accountType,AccNote:r.notes,AccRef:r.AccRef};await Y(c),g()}catch(c){console.error("Error updating form:",c)}finally{y(!1)}};return e.jsxs(F,{open:p,onClose:g,maxWidth:"sm",fullWidth:!0,children:[e.jsx(B,{children:b===1?"تعديل حساب رئيسي":"تعديل حساب"}),e.jsx(W,{children:e.jsxs(C,{sx:{display:"flex",justifyContent:"space-between",gap:2},children:[e.jsxs(C,{sx:{flex:1},children:[e.jsx(N,{label:"اسم الحساب",value:r.accountName,onChange:l("accountName"),fullWidth:!0,required:!0,margin:"normal",error:!!d.accountName,helperText:d.accountName}),e.jsx(N,{label:"رقم المرجع",value:r.AccRef,onChange:l("AccRef"),type:"number",fullWidth:!0,margin:"normal",error:!!d.AccRef,helperText:d.AccRef}),e.jsx(N,{label:"ملاحظات",value:r.notes,onChange:l("notes"),fullWidth:!0,margin:"normal",multiline:!0,rows:4})]}),e.jsxs(C,{sx:{flex:1},children:[e.jsx(N,{label:"رقم الحساب",value:r.accountNumber,onChange:l("accountNumber"),type:"number",fullWidth:!0,required:!0,margin:"normal",error:!!d.accountNumber,helperText:d.accountNumber,disabled:!0}),e.jsx(M,{options:a.filter(t=>{const c=t.AccID!==r.accountNumber,R=P=>{if(P.Father===r.accountNumber)return!1;const O=a.find(Q=>Q.AccID===P.Father);return O?R(O):!0};return c&&R(t)}),getOptionLabel:t=>`${t.AccID} - ${t.AccName}`,value:r.mainAccount||null,onChange:l("mainAccount"),renderInput:t=>e.jsx(N,{...t,label:"الحساب الرئيسي",margin:"normal",required:!0,error:!!d.mainAccount,helperText:d.mainAccount}),fullWidth:!0}),e.jsxs(G,{value:r.accountType.toString(),onChange:l("accountType"),row:!0,sx:{mt:2},children:[e.jsx(I,{value:"1",control:e.jsx(w,{}),label:"دائن"}),e.jsx(I,{value:"0",control:e.jsx(w,{}),label:"مدين"})]})]})]})}),e.jsxs(k,{children:[e.jsx(E,{onClick:n,color:"error",variant:"outlined",disabled:A,children:"حذف"}),e.jsx(C,{sx:{flexGrow:1}}),e.jsx(E,{onClick:g,color:"secondary",children:"إلغاء"}),e.jsx(E,{onClick:s,color:"primary",variant:"contained",disabled:A,children:A?e.jsxs(e.Fragment,{children:["قيد الحفظ",e.jsx(z,{size:24,sx:{ml:1}})]}):"حفظ التغييرات"})]}),e.jsxs(F,{open:f,onClose:x,"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description",children:[e.jsx(B,{id:"alert-dialog-title",children:"تأكيد الحذف"}),e.jsx(W,{children:e.jsx(oe,{id:"alert-dialog-description",children:"هل أنت متأكد من حذف هذا الحساب؟"})}),e.jsxs(k,{children:[e.jsx(E,{onClick:x,children:"إلغاء"}),e.jsx(E,{onClick:h,autoFocus:!0,children:"تأكيد"})]})]})]})},le=p=>e.jsx(K,{...p,editType:1}),$e=()=>{const[p,g]=u.useState([]),[b,S]=u.useState([]),[j,o]=u.useState(0),[a,r]=u.useState(!1),[m,d]=u.useState(0),T=[{text:"كشف حساب",component:_,isDisabled:!1},{text:"تعين مركز مالي",component:{},isDisabled:!1},{text:"ميزان مراجعة",component:se,isDisabled:!1},{text:"ميزان مراجعة تفصيلي",component:{},isDisabled:!1}],A=[{field:"AccName",headerName:"الحساب",flex:2,minWidth:200,valueGetter:i=>`${i.row.AccID} - ${i.row.AccName}`},{field:"AccNameE",headerName:"Account",flex:2,minWidth:200,valueGetter:i=>`${i.row.AccNameE}`},{field:"AccD",headerName:"طبيعة الحساب",flex:1,minWidth:150,valueGetter:i=>i.row.AccD?"دائن":"مدين"},{field:"Balance",headerName:"الرصيد",flex:1,minWidth:100}],y=async()=>{try{const i=await L("/api/accounting/structure/list/main",{});g(i)}catch(i){console.error("Error fetching client tree data:",i)}},f=async(i,n,h,x,l,s,t)=>{try{r(!0);const c=await L("/api/accounting/structure/list/sub",{Father:i,page:n,pageSize:h,rowID:x,search:l,field:s,sort:t});r(!1),S(c.data),o(c.totalRows),c.page!==null&&d(c.page)}catch(c){console.error("Error fetching client tree data:",c),r(!1)}};return u.useEffect(()=>{y()},[]),e.jsx(Z,{mainData:p,rows:b,dataKey:"AccID",dataCode:"AccID",Name:"AccName",fetchTreeData:y,fetchSubTreeData:f,columns:A,apiSearchEndpoint:"/api/accounting/structure/search",PopupAddMain:ie,PopupEditMain:le,AddEntityComponent:H,EditEntityComponent:K,rowCount:j,isLoading:a,entityName:"حساب",mainName:"مجموعة",page:m,setPage:d,reportOptions:T})};export{$e as default};
