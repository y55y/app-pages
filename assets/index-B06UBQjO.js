import{r as a,j as n,B as V,n as M,R as U,I as z,an as X,G as D,$ as ee,a0 as te,aZ as ne,bG as oe,bL as re}from"./index-Bh1Mwprf.js";import{d as Y,A as ae}from"./AdapterDayjs-s1qz8Y9-.js";import{g as se}from"./userinfo-BaXCAmfp.js";import{d as $,A as ie,a as ce}from"./ag-theme-alpine-BbHZ7iEh.js";import{d as le}from"./Delete-4WWjmxdf.js";import{A as W}from"./Autocomplete-Cg6Ig2cR.js";import{T as S}from"./TextField-DtvSnH-b.js";import{s as de}from"./payment-5BrlduVE.js";import{A as ue,E as ge}from"./AddCategoryDialog-DL6PeDGa.js";import{D as he,a as fe,b as me}from"./DialogContent-CjcOC2rl.js";import{L as ye,D as pe}from"./DatePicker-BDpYDSvC.js";import{I as _}from"./InputAdornment-CMztuF7B.js";import"./FormHelperText-B649Xu3c.js";import"./DialogTitle-MYypWVVC.js";import"./ListItem-CevmG2Sc.js";const xe=({rowData:m,setRowData:C,accounts:A})=>{const[s,y]=a.useState([]),[v,R]=a.useState(null);a.useEffect(()=>{if(m&&m.length>0){const e=m.reduce((c,p)=>c+(parseFloat(p.debit)||0),0),r=m.reduce((c,p)=>c+(parseFloat(p.credit)||0),0);y([{account:"الاجمالي",description:"",debit:e,credit:r}])}else y([{account:"الاجمالي",description:"",debit:0,credit:0}])},[m]);const I=e=>{const[r,c]=a.useState(e.value||""),[p,d]=a.useState(null),l=U.useRef(null);a.useEffect(()=>{l.current&&l.current.focus()},[]),a.useEffect(()=>{c(e.value||""),d(A.find(g=>g.accName===e.value)||null)},[e.value]);const E=(g,x)=>{const w=x?x.accId:"",j=x?x.accName:"";c(j),d(x),L(j,w),e.rowIndex===m.length-1&&k()},L=(g,x)=>{C(w=>{const j=[...w];return j[e.rowIndex]={...j[e.rowIndex],account:g,accId:x},j})},F=g=>{g.key==="Enter"&&(g.preventDefault(),e.api.stopEditing(),e.api.setFocusedCell(e.rowIndex,e.column))};return n.jsx(V,{sx:{display:"flex",alignItems:"center",width:"100%",minHeight:"110%"},children:n.jsx(W,{options:A,getOptionLabel:g=>g.accName,value:p,onChange:E,inputValue:r,onInputChange:(g,x)=>{c(x)},renderInput:g=>n.jsx(S,{...g,size:"small",fullWidth:!0,inputRef:l,onKeyDown:F}),sx:{width:"100%",height:"100%"}})})},b=e=>typeof e=="number"&&!isNaN(e)?e.toFixed(2):"",O=[{headerName:"الحساب",field:"account",editable:e=>!e.node.rowPinned,cellEditor:I,rowDrag:!0,suppressKeyboardEvent:e=>!!(e.event.key==="Enter"&&e.editing)},{headerName:"الوصف",field:"description",editable:e=>!e.node.rowPinned,cellEditor:"agTextCellEditor",valueParser:e=>{if(e.newValue==="/"){const r=e.node.rowIndex;if(r>0)return e.api.getDisplayedRowAtIndex(r-1).data.description}return e.newValue}},{headerName:"مدين",field:"debit",editable:e=>!e.node.rowPinned,valueParser:e=>{if(e.newValue==="/"){const c=e.api.getModel().rowsToDisplay.reduce((d,l)=>l!==e.node?d+(l.data.credit||0):d,0),p=e.api.getModel().rowsToDisplay.reduce((d,l)=>l!==e.node?d+(l.data.debit||0):d,0);return Math.max(0,c-p)}const r=parseInt(e.newValue,10);return r>0?r:0},valueFormatter:e=>b(e.value),onCellValueChanged:e=>{e.newValue&&(e.data.credit=0,e.api.refreshCells({rowNodes:[e.node],columns:["credit"]}))}},{headerName:"دائن",field:"credit",editable:e=>!e.node.rowPinned,valueParser:e=>{if(e.newValue==="/"){const c=e.api.getModel().rowsToDisplay.reduce((d,l)=>l!==e.node?d+(l.data.credit||0):d,0),p=e.api.getModel().rowsToDisplay.reduce((d,l)=>l!==e.node?d+(l.data.debit||0):d,0);return Math.max(0,p-c)}const r=parseInt(e.newValue,10);return r>0?r:0},valueFormatter:e=>b(e.value),onCellValueChanged:e=>{e.newValue&&(e.data.debit=0,e.api.refreshCells({rowNodes:[e.node],columns:["debit"]}))}}],f=e=>{const r=[];e.api.forEachNode(c=>{r.push(c.data)}),C(r)},q=e=>{const r=[...m];r[e.node.rowIndex]=e.data,C(r)},h=()=>{v&&(C(e=>e.filter(r=>r!==v)),R(null))},k=()=>{C(e=>[...e,{account:"",accId:"",description:"",debit:0,credit:0}])},P=e=>{const r=e.api.getSelectedRows();R(r.length>0?r[0]:null)};return n.jsxs("div",{children:[n.jsxs(V,{sx:{display:"flex",gap:"10px",marginBottom:"10px"},children:[n.jsx(M,{variant:"outlined",color:"primary",startIcon:n.jsx($,{}),onClick:k,children:"اضف صف"}),n.jsx(M,{variant:"outlined",color:"error",startIcon:n.jsx(le,{}),onClick:h,disabled:!v,children:"حذف الصف"})]}),n.jsx("div",{className:"ag-theme-alpine",style:{height:400,width:"100%"},children:n.jsx(ie,{rowData:m,columnDefs:O,rowDragManaged:!0,animateRows:!0,onRowDragEnd:f,onCellValueChanged:q,enableRtl:!0,defaultColDef:{flex:1},rowSelection:"single",pinnedBottomRowData:s,onSelectionChanged:P})})]})},Le=({open:m,onClose:C,selectedSubRowId:A})=>{var K;const[s,y]=a.useState({entryNumber:"",entryDate:Y(),notes:"",locationId:"",category:""}),[v,R]=a.useState([]),[I,b]=a.useState([]),[O,f]=a.useState(!1),[q,h]=a.useState(""),[k,P]=a.useState(!1),[e,r]=a.useState(!1),[c,p]=a.useState(null),[d,l]=a.useState([]),[E,L]=a.useState([]);a.useEffect(()=>{(async()=>{try{const o=await ne(A);console.log(o),y({entryNumber:o.qidID,entryDate:Y(o.qidDate),notes:o.qidnote,locationId:o.qidIstore,category:o.qidI||""}),L(o.entries.map(u=>({account:u.AccName,accId:u.qidEAcc,description:u.qidEnote,debit:u.qidEAmountD,credit:u.qidEAmountC})))}catch(o){console.error("Error fetching entry data:",o)}})()},[m]),a.useEffect(()=>{F()},[]);const F=async()=>{try{const t=await se();t&&Array.isArray(t.stores)?R(t.stores):console.error("Fetched data does not contain stores array:",t)}catch(t){console.error("Error fetching locations:",t.message)}};a.useEffect(()=>{(async()=>{try{const o=await de(["AccList","CategoryList"]),u=o.AccList.map(N=>({accId:N.AccID,accName:N.AccName}));l(u),b(o.CategoryList)}catch(o){console.error("Error fetching payment methods:",o)}})()},[]);const g=()=>{P(!0)},x=t=>{b([...I,t]),y({...s,category:t.CategoryID}),h("تم إضافة التصنيف الجديد بنجاح"),f(!0)},w=()=>{const t=I.find(o=>o.CategoryID===s.category);t?(p(t),r(!0)):(h("يرجى اختيار تصنيف أولاً"),f(!0))},j=async t=>{try{if(t===null){const o=I.filter(u=>u.CategoryID!==c.CategoryID);b(o),y({...s,category:""}),h("تم حذف التصنيف بنجاح")}else{await oe(t.CategoryID,t);const o=I.map(u=>u.CategoryID===t.CategoryID?t:u);b(o),y({...s,category:t.CategoryID}),h("تم تحديث التصنيف بنجاح")}f(!0)}catch(o){console.error("Error updating category:",o),h("حدث خطأ أثناء تحديث التصنيف"),f(!0)}},B=t=>{y({...s,[t.target.name]:t.target.value})},G=(t,o)=>{o!=="clickaway"&&f(!1)},H=t=>{y({...s,entryDate:t})},Z=async t=>{if(t.preventDefault(),E.find(i=>(i.description||i.credit>0||i.debit>0)&&!i.accId)){h("يجب اضافة حساب لحفظ الصف"),f(!0);return}const u=E.reduce((i,T)=>i+Number(T.debit),0),N=E.reduce((i,T)=>i+Number(T.credit),0);if(u!==N){h("المدين لا يساوي الدائن"),f(!0);return}if(u<=0||N<=0){h("الاجمالي يجب ان يكون اعلى من صفر"),f(!0);return}const J=E.filter(i=>i.accId),Q={qidID:s.entryNumber,qidIstore:s.locationId||"",qidnote:s.notes,qidDate:s.entryDate.format("YYYY-MM-DD"),qidType:s.category,entries:J.map(i=>({qidEAcc:i.accId,qidEAmountD:i.debit,qidEAmountC:i.credit,qidEnote:i.description}))};try{await re(A,Q),h("تم تحديث القيد بنجاح"),f(!0),C()}catch(i){console.error("Error updating entry:",i),i.message==="cannot edit auto qid"?h("لا يمكن تعديل قيد آلي"):h("حدث خطأ أثناء تحديث القيد"),f(!0)}};return n.jsxs(he,{open:m,onClose:C,maxWidth:"md",fullWidth:!0,sx:{"& .MuiDialog-paper":{maxWidth:"80%",width:"80%"}},children:[n.jsx(z,{"aria-label":"close",onClick:C,sx:{position:"absolute",right:8,top:8,color:t=>t.palette.grey[500]},children:n.jsx(X,{})}),n.jsxs("form",{onSubmit:Z,children:[n.jsxs(fe,{children:[n.jsx(V,{sx:{p:2.5},children:n.jsxs(D,{container:!0,spacing:2,children:[n.jsx(D,{item:!0,xs:12,sm:6,children:n.jsxs(D,{container:!0,spacing:2,children:[n.jsx(D,{item:!0,xs:6,children:n.jsx(S,{fullWidth:!0,label:"رقم القيد",size:"small",name:"entryNumber",value:s.entryNumber,onChange:B,disabled:!0})}),n.jsx(D,{item:!0,xs:12,children:n.jsx(S,{fullWidth:!0,multiline:!0,rows:3,label:"ملاحظات",size:"small",name:"notes",value:s.notes,onChange:B})})]})}),n.jsx(D,{item:!0,xs:12,sm:3}),n.jsx(D,{item:!0,xs:12,sm:3,children:n.jsxs(D,{container:!0,spacing:2,children:[n.jsx(D,{item:!0,xs:12,children:n.jsx(ye,{dateAdapter:ae,children:n.jsx(pe,{label:"تاريخ القيد",value:s.entryDate,slotProps:{textField:{fullWidth:!0,size:"small"}},onChange:H,renderInput:t=>n.jsx(S,{...t,fullWidth:!0,size:"small"})})})}),n.jsx(D,{item:!0,xs:12,children:n.jsx(W,{fullWidth:!0,options:v,getOptionLabel:t=>t?t.StoreName:"",renderInput:t=>n.jsx(S,{...t,label:"الموقع",size:"small"}),value:v.find(t=>t.StoreID===s.locationId)||null,onChange:(t,o)=>{y({...s,locationId:o?o.StoreID:""})},isOptionEqualToValue:(t,o)=>t.StoreID===o.StoreID,noOptionsText:"لا توجد مواقع",renderOption:(t,o)=>a.createElement("li",{...t,key:o.StoreID},o.StoreName)})}),n.jsx(D,{item:!0,xs:12,children:n.jsx(W,{fullWidth:!0,options:I,value:I.find(t=>t.CategoryID===s.category)||{CategoryID:0,CategoryName:((K=I.find(t=>t.CategoryID===0))==null?void 0:K.CategoryName)||""},onChange:(t,o)=>{y({...s,category:o?o.CategoryID:0})},getOptionLabel:t=>t.CategoryName||"",isOptionEqualToValue:(t,o)=>t.CategoryID===o.CategoryID,renderInput:t=>n.jsx(S,{...t,label:"التصنيف",size:"small",InputProps:{...t.InputProps,startAdornment:n.jsxs(n.Fragment,{children:[n.jsx(_,{position:"start",children:n.jsx(z,{onClick:g,size:"small",children:n.jsx($,{sx:{color:"#2196f3"}})})}),t.InputProps.startAdornment]}),endAdornment:n.jsxs(n.Fragment,{children:[t.InputProps.endAdornment,n.jsx(_,{position:"end",children:n.jsx(z,{onClick:w,size:"small",children:n.jsx(ce,{sx:{color:"#2196f3"}})})})]})}}),renderOption:(t,o)=>a.createElement("li",{...t,key:o.CategoryID},o.CategoryName)})})]})})]})}),n.jsx(xe,{rowData:E,setRowData:L,accounts:d})]}),n.jsxs(me,{children:[n.jsx(M,{onClick:C,children:"إلغاء"}),n.jsx(M,{type:"submit",variant:"contained",color:"primary",children:"حفظ التعديلات"})]})]}),n.jsx(ee,{open:O,autoHideDuration:6e3,onClose:G,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:n.jsx(te,{onClose:G,severity:q.includes("نجاح")?"success":"error",sx:{width:"100%",display:"flex",justifyContent:"center","& .MuiAlert-message":{width:"100%",textAlign:"center"}},children:q})}),n.jsx(ue,{open:k,onClose:()=>P(!1),onSave:x}),n.jsx(ge,{open:e,onClose:()=>r(!1),category:c,onSave:j})]})};export{Le as default};
