import{R as H,N as z,r as l,j as e,G as i,n as A,k as h,S as $,Z as L,q as p,h as X}from"./index-DOK7aCTJ.js";import{p as G,g as R,u as Y}from"./fetchdata-sUCg7VRO.js";import{B as M}from"./index-BmFppD3x.js";import{A as ee}from"./AccountStatement-rrNoIE4t.js";import{C as te}from"./CustomAccordion-BaVKURbL.js";import{D as O,a as _,b as q}from"./DialogContent-Djw2bZG_.js";import{D as I}from"./DialogTitle-uQU4vRl-.js";import{C as E}from"./CircularProgress-x_j_4Fry.js";import{T,S as re}from"./TextField-DpzXL4Ju.js";import{a as oe,I as se}from"./FormHelperText-CEQeOJZI.js";import{M as P}from"./MenuItem-B9bun-nE.js";import{F as S}from"./FormControlLabel-CfK8C1zG.js";import{C as v}from"./Checkbox-DY0zuuHu.js";import"./Search-ZrCv_Edx.js";import"./Autocomplete-UszSgsiJ.js";import"./InputAdornment-C1RBlpLr.js";import"./TablePagination-rvU7ByLE.js";import"./KeyboardArrowRight-OGCTZ71I.js";import"./TableCell-C3RUmQ-j.js";import"./DataGrid-x3xnmkzo.js";import"./typeof-QjJsDpFa.js";import"./Skeleton-BcgQ7l1g.js";import"./MessageSnackbar-C0QokbLa.js";import"./SubCard-DQmm69x_.js";import"./index-D5JGTKjL.js";import"./TableRow-_YPF1XSs.js";import"./TableHead-DituZabM.js";const K=H.memo(({open:t,selectedRowId:s,setMessage:o,setIsLoading:r,onClose:n})=>{const c=z(),[d,x]=l.useState(!1),b=l.useCallback(async()=>{if(!(!t||!s||d)){x(!0),r(!0);try{const u=await G("/api/invoice/new",{Father:s});if(u&&u.InvoiceID)o({open:!0,type:"success",text:"تمت إضافة الفاتورة بنجاح"}),c(`/apps/invoice/edit/${u.InvoiceID}`);else throw new Error("فشل في إضافة الفاتورة")}catch(u){console.error("خطأ في إضافة الفاتورة:",u),u.error.includes("Invalid Father format")?o({open:!0,type:"error",text:"يجب تحديد نوع الفاتورة"}):o({open:!0,type:"error",text:"فشل في إضافة الفاتورة"})}finally{r(!1),n()}}},[t,s,d,o,r,c,n]);return l.useEffect(()=>{t&&!d&&(s?b():(o({open:!0,type:"warning",text:"الرجاء تحديد صف أولاً"}),n()))},[t,s,d,b,o,n]),l.useEffect(()=>{t||x(!1)},[t]),null});K.displayName="AddSub";const Z=H.memo(({open:t,selectedSubRowId:s})=>{const o=z(),r=l.useCallback(()=>{t&&s&&(console.log("Redirecting to:",`/apps/invoice/edit/${s}`),o(`/apps/invoice/edit/${s}`))},[t,s,o]);return l.useEffect(()=>{r()},[r]),null});Z.displayName="EditSub";const J=({newStore:t,setNewStore:s,loading:o,handleInputChange:r,expanded:n,handleAccordionChange:c})=>e.jsxs(e.Fragment,{children:[e.jsxs(i,{container:!0,spacing:2,pb:2,children:[e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(T,{autoFocus:!0,margin:"dense",name:"StoreName",label:"اسم الموقع",type:"text",fullWidth:!0,variant:"outlined",value:t.StoreName,onChange:r})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(T,{margin:"dense",name:"StoreCode",label:"رمز الموقع",type:"text",fullWidth:!0,variant:"outlined",value:t.StoreCode,onChange:r})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(T,{margin:"dense",name:"Region",label:"المنطقة",type:"text",fullWidth:!0,variant:"outlined",value:t.Region,onChange:r})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(T,{margin:"dense",name:"Address1",label:"العنوان",type:"text",fullWidth:!0,variant:"outlined",value:t.Address1,onChange:r})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsxs(oe,{fullWidth:!0,margin:"dense",children:[e.jsx(se,{children:"نوع الموقع"}),e.jsxs(re,{name:"StoreT",value:t.StoreT,onChange:r,label:"نوع الموقع",children:[e.jsx(P,{value:!1,children:"مخزن"}),e.jsx(P,{value:!0,children:"فرع"})]})]})})]}),e.jsxs(te,{title:"تفعيل انواع فواتير اضافية",expanded:n,onChange:c,customBackgroundColor:"rgb(227 242 253 / 30%)",children:[e.jsx(h,{variant:"subtitle1",sx:{mt:2},children:"المشتريات"}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:12,sm:4,children:e.jsx(S,{control:e.jsx(v,{checked:t.b111,onChange:r,name:"b111"}),label:"طلبات الشراء"})}),e.jsx(i,{item:!0,xs:12,sm:4,children:e.jsx(S,{control:e.jsx(v,{checked:t.b112,onChange:r,name:"b112"}),label:"طلبات العروض"})}),e.jsx(i,{item:!0,xs:12,sm:4,children:e.jsx(S,{control:e.jsx(v,{checked:t.b113,onChange:r,name:"b113"}),label:"عروض الاسعار"})})]}),e.jsx(h,{variant:"subtitle1",sx:{mt:3},children:"المبيعات"}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:12,sm:4,children:e.jsx(S,{control:e.jsx(v,{checked:t.s211,onChange:r,name:"s211"}),label:"طلبات البيع"})}),e.jsx(i,{item:!0,xs:12,sm:4,children:e.jsx(S,{control:e.jsx(v,{checked:t.s212,onChange:r,name:"s212"}),label:"طلبات العروض"})}),e.jsx(i,{item:!0,xs:12,sm:4,children:e.jsx(S,{control:e.jsx(v,{checked:t.s213,onChange:r,name:"s213"}),label:"عروض الاسعار"})})]})]})]}),ae=({open:t,onClose:s,setMessage:o})=>{const[r,n]=l.useState({StoreName:"",StoreCode:"",Region:"",Address1:"",StoreT:!0,b111:!1,b112:!1,b113:!1,s211:!1,s212:!1,s213:!1}),[c,d]=l.useState(!1),[x,b]=l.useState(!1),u=m=>{const{name:y,value:j,checked:a}=m.target;n(f=>({...f,[y]:m.target.type==="checkbox"?a:j}))},N=async()=>{if(!r.StoreName||!r.StoreCode){o({open:!0,type:"error",text:"يرجى إدخال اسم الموقع ورمزه"});return}try{d(!0);const m=await G("/api/store/add",r);m&&!m.error?(o({open:!0,type:"success",text:"تم حفظ الموقع بنجاح"}),g()):o({open:!0,type:"error",text:m.error||"حدث خطأ غير متوقع أثناء حفظ الموقع"})}catch(m){console.error("Error saving store:",m),o({open:!0,type:"error",text:`خطأ أثناء الاتصال بالخادم: ${m.message}`})}finally{d(!1)}},g=()=>{n({StoreName:"",StoreCode:"",Region:"",Address1:"",StoreT:!0,b111:!1,b112:!1,b113:!1,s211:!1,s212:!1,s213:!1}),s()};return e.jsxs(O,{open:t,onClose:g,maxWidth:"md",fullWidth:!0,children:[e.jsx(I,{children:"إضافة موقع جديد"}),e.jsx(_,{children:c?e.jsx(i,{container:!0,justifyContent:"center",alignItems:"center",style:{minHeight:"200px"},children:e.jsx(E,{})}):e.jsx(J,{newStore:r,setNewStore:n,loading:c,handleInputChange:u,expanded:x,handleAccordionChange:(m,y)=>b(y)})}),e.jsxs(q,{children:[e.jsx(A,{onClick:g,children:"إلغاء"}),e.jsx(A,{onClick:N,disabled:c,children:c?e.jsx(E,{size:24}):"حفظ"})]})]})},le=({open:t,onClose:s,setMessage:o,selectedRowId:r})=>{const n=r?r.toString().slice(1):null,[c,d]=l.useState({StoreName:"",StoreCode:"",Region:"",Address1:"",StoreT:!0,b111:!1,b112:!1,b113:!1,s211:!1,s212:!1,s213:!1}),[x,b]=l.useState(!1),[u,N]=l.useState(!1);l.useEffect(()=>{t&&n&&g()},[t,n]);const g=async()=>{b(!0);try{const a=await R(`/api/store/${n}`);a&&d(a)}catch(a){console.error("Error fetching store data:",a),o({open:!0,type:"error",text:`Failed to fetch store data: ${a.message}`})}finally{b(!1)}},m=a=>{const{name:f,value:D,checked:w}=a.target;d(W=>({...W,[f]:a.target.type==="checkbox"?w:D}))},y=async()=>{if(!c.StoreName||!c.StoreCode){o({open:!0,type:"error",text:"يرجى إدخال اسم الموقع ورمزه"});return}try{b(!0);const a=await Y("/api/store/edit",n,c);a&&!a.error?(o({open:!0,type:"success",text:"تم تعديل الموقع بنجاح"}),j()):o({open:!0,type:"error",text:a.error||"حدث خطأ غير متوقع أثناء تعديل الموقع"})}catch(a){console.error("Error saving store:",a),o({open:!0,type:"error",text:`خطأ أثناء الاتصال بالخادم: ${a.message}`})}finally{b(!1)}},j=()=>{d({StoreName:"",StoreCode:"",Region:"",Address1:"",StoreT:!0,b111:!1,b112:!1,b113:!1,s211:!1,s212:!1,s213:!1}),s()};return e.jsxs(O,{open:t,onClose:j,maxWidth:"md",fullWidth:!0,children:[e.jsx(I,{children:"تعديل الموقع"}),e.jsx(_,{children:x?e.jsx(i,{container:!0,justifyContent:"center",alignItems:"center",style:{minHeight:"200px"},children:e.jsx(E,{})}):e.jsx(J,{newStore:c,setNewStore:d,loading:x,handleInputChange:m,expanded:u,handleAccordionChange:(a,f)=>N(f)})}),e.jsxs(q,{children:[e.jsx(A,{onClick:j,children:"إلغاء"}),e.jsx(A,{onClick:y,disabled:x,children:x?e.jsx(E,{size:24}):"حفظ"})]})]})},ne=t=>{switch(t){case 1:return{label:"غير مدفوع",color:"error.main",chipcolor:p("#ffcdd2",.2)};case 2:return{label:"مدفوع جزئي",color:"#fb6300",chipcolor:p("#ffe0b2",.5)};case 3:return{label:"مدفوع",color:"success.dark",chipcolor:p("#c8e6c9",.5)};default:return{label:"غير مدفوع",color:"error.main",chipcolor:p("#ffcdd2",.2)}}},ce=t=>{switch(t){case 1:return{closedlabel:"تحت الاجراء",closedcolor:"black",closedchipcolor:p("#D3D3D3",.3)};case 2:return{closedlabel:"مطلوب التعديل",closedcolor:"info.dark",closedchipcolor:p("#b3e5fc",.5)};case 3:return{closedlabel:"موقف",closedcolor:"error.main",closedchipcolor:p("#ffcdd2",.5)};case 4:return{closedlabel:"تحت التسليم",closedcolor:"black",closedchipcolor:p("#ffecad",.5)};case 5:return{closedlabel:"مستلم",closedcolor:"success.dark",closedchipcolor:p("#c8e6c9",.5)};case 7:return{closedlabel:"مستلم غير مطابق",closedcolor:"black",closedchipcolor:p("#c8e6c9",.5)};case 9:return{closedlabel:"مستلم ناقص",closedcolor:"black",closedchipcolor:p("#c8e6c9",.5)};default:return{closedlabel:"تحت الاجراء",closedcolor:"warning.dark",closedchipcolor:p("#fff9c4",.5)}}},ie=t=>t===8?e.jsx(h,{variant:"subtitle1",style:{color:"#673ab7"},children:"مكتملة"}):e.jsx(h,{variant:"subtitle1",style:{color:"grey"},children:"مسودة"}),k=[{field:"ID",headerName:"الرقم",minWidth:100,flex:.5,align:"left",renderCell:t=>e.jsxs($,{children:[e.jsxs(h,{variant:"h5",align:"center",children:["#",t.row.ReferenceNumber]}),ie(t.row.status)]})},{field:"ClientName",headerName:"المورد",minWidth:150,flex:2,align:"left",renderCell:t=>e.jsxs($,{children:[e.jsx(h,{variant:"h5",children:t.row.ClientName}),e.jsx(h,{variant:"caption",children:t.row.ClientID})]})},{field:"payment_status",headerName:"حالة الدفع",minWidth:150,flex:1,align:"left",renderCell:t=>{const{label:s,color:o,chipcolor:r}=ne(t.row.payment_status);return e.jsx(L,{label:s,style:{backgroundColor:r,color:o}})}},{field:"closed",headerName:"حالة الإغلاق",minWidth:150,flex:1,align:"left",renderCell:t=>{const{closedlabel:s,closedcolor:o,closedchipcolor:r}=ce(t.row.closed);return e.jsx(L,{label:s,style:{backgroundColor:r,color:o}})}},{field:"date",headerName:"تاريخ الفاتورة",minWidth:150,flex:1,align:"left",renderCell:t=>e.jsx(h,{variant:"body2",children:t.row.date})},{field:"Total",headerName:"المبلغ الإجمالي",minWidth:150,flex:1,align:"left",renderCell:t=>e.jsx(h,{variant:"body2",children:t.row.Total+t.row.Tax})}],F={columns:k},B={1:{type:"المشتريات",columns:[...k,{field:"purchaseSpecific",headerName:"المشتريات",minWidth:150,flex:1,align:"left",renderCell:t=>e.jsx(h,{variant:"body2",children:t.row.purchaseSpecific})}]},2:{type:"المبيعات",columns:[...k,{field:"salesSpecific",headerName:"المبيعات",minWidth:150,flex:1,align:"left",renderCell:t=>e.jsx(h,{variant:"body2",children:t.row.salesSpecific})}]},3:{type:"التسويات",columns:[...k,{field:"adjustmentSpecific",headerName:"التسويات",minWidth:150,flex:1,align:"left",renderCell:t=>e.jsx(h,{variant:"body2",children:t.row.adjustmentSpecific})}]},4:{type:"الجرد",columns:[...k,{field:"inventorySpecific",headerName:"الجرد",minWidth:150,flex:1,align:"left",renderCell:t=>e.jsx(h,{variant:"body2",children:t.row.inventorySpecific})}]}},de=t=>{if(!t)return F;const s=t.match(/S(\d+)C(\d+)T?(\d+)?/);if(!s)return F;const[,o,r,n]=s;return B[n]||B[r]||F},He=()=>{const[t,s]=l.useState([]),[o,r]=l.useState([]),[n,c]=l.useState(0),[d,x]=l.useState(0),[b,u]=l.useState(!1);X();const[N,g]=l.useState(0),m=[{text:"كشف حساب",component:ee,isDisabled:!1}],y=f=>{g(f)},j=async()=>{try{const f=await R("/api/invoices/list/main",{});s(f)}catch(f){console.error("Error fetching client tree data:",f)}},a=async(f,D,w,W,Q,U,V)=>{try{u(!0);const C=await R("/api/invoices/list/sub",{Father:f,page:D,pageSize:w,rowID:W,search:Q,field:U,sort:V});r(C.data),c(C.totalRows),C.page!==null&&x(C.page),u(!1)}catch(C){console.error("Error fetching client tree data:",C),u(!1)}};return l.useEffect(()=>{j()},[]),e.jsx(M,{mainData:t,rows:o,dataKey:"ID",dataCode:"Code",Name:"Name",fetchTreeData:j,fetchSubTreeData:a,columns:de(N).columns,apiSearchEndpoint:"/api/invoices/search",PopupAddMain:ae,PopupEditMain:le,AddEntityComponent:K,EditEntityComponent:Z,rowCount:n,entityName:"فاتورة",mainName:"موقع",page:d,isLoading:b,setPage:x,reportOptions:m,disableIDTree:!0,isTypeIcon:!0,onSelectedRowIdChange:y})};export{He as default};
